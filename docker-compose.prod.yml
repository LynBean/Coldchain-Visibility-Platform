name: coldchain-visibility-platform

services:
  web:
    container_name: coldchain-visibility-platform-web
    image: ghcr.io/lynbean/coldchain-visibility-platform/web:${DOCKER_IMAGE_TAG:-latest}
    build:
      context: web
      dockerfile: Dockerfile.prod

    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000"]
      timeout: 20s
      interval: 20s
      retries: 2
    networks:
      - coldchain-visibility-platform
    ports:
      - 3000:3000
    restart: always

  api:
    container_name: coldchain-visibility-platform-api
    image: ghcr.io/lynbean/coldchain-visibility-platform/api:${DOCKER_IMAGE_TAG:-latest}
    build:
      context: api
      dockerfile: Dockerfile.prod

    healthcheck:
      test: ["CMD", "wget", "--no-versbose", "--tries=1", "http://127.0.0.1:5000/health"]
      timeout: 20s
      interval: 20s
      retries: 2
    networks:
      - coldchain-visibility-platform
    ports:
      - 5000:5000
    restart: always
    environment:
      WEB_URL: ${WEB_URL}
      SUPABASE_URL: https://${SUPABASE_PROJECT_ID}.supabase.co
      SUPABASE_SECRET_KEY: ${SUPABASE_SECRET_KEY}
      SUPABASE_DB_URL: postgresql://postgres.${SUPABASE_PROJECT_ID}:${SUPABASE_DB_PASSWORD}@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres
      REDIS_URL: redis://redis:6379

  redis:
    container_name: coldchain-visibility-platform-redis
    image: redis:8
    networks:
      - coldchain-visibility-platform
    ports:
      - 6379:6379
    restart: always

networks:
  coldchain-visibility-platform:
